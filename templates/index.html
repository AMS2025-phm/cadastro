<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Localidades e Unidades</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        /* Estilos adicionais para Select2 ou para o layout específico desta página */
        .select2-container--default .select2-selection--single {
            height: 40px;
            display: flex;
            align-items: center;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 38px;
        }
        .select2-container .select2-selection--single .select2-selection__rendered {
            line-height: 38px;
        }
        .app-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px; /* Espaçamento entre as seções */
            margin-top: 30px;
        }
        .section-left, .section-right {
            flex: 1; /* Permite que as seções ocupem o espaço disponível */
            min-width: 300px; /* Largura mínima para evitar quebras estranhas */
        }
        .section-right {
            border-left: 1px solid #eee; /* Separador visual */
            padding-left: 30px;
        }
        @media (max-width: 768px) {
            .app-content {
                flex-direction: column;
            }
            .section-right {
                border-left: none;
                border-top: 1px solid #eee;
                padding-left: 0;
                padding-top: 30px;
            }
        }
        .medidas-dinamicas {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            background-color: #fcfcfc;
            margin-top: 20px;
        }
        .medidas-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
            max-height: 200px; /* Altura máxima para rolagem */
            overflow-y: auto; /* Adiciona barra de rolagem se necessário */
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 5px;
        }
        .medidas-list li {
            background-color: #e9ecef;
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }
        .medidas-list li.selected {
            background-color: #cfe2ff; /* Cor de seleção */
            border-color: #0d6efd;
        }
        .medidas-list li button {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.1em;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .btn-group .btn {
            flex: 1;
        }
        .inline-fields {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 15px; /* Espaçamento entre grupos de campos */
        }
        .inline-fields > div {
            flex: 1;
        }
        .inline-fields label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .inline-fields input {
            width: calc(100% - 20px); /* Ajusta largura com padding */
        }
        .localidade-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f8f8;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px 15px;
            margin-bottom: 10px;
        }
        .localidade-list li a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="app-header">
            <h1>Cadastro de Unidades e Medidas</h1>
            <nav>
                <a href="{{ url_for('index') }}" class="btn">Início</a>
                <a href="{{ url_for('nova_localidade') }}" class="btn">Nova Localidade</a>
                <a href="{{ url_for('logout') }}" class="btn btn-danger">Sair ({{ g.user.username }})</a>
            </nav>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flashes">
                    {% for category, message in messages %}
                        <li class="{{ category }}">{{ message }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <div class="app-content">
            <section class="section-left">
                <h2>Dados da Unidade</h2>
                <form id="cadastroForm" action="{{ url_for('adicionar_unidade') }}" method="POST">
                    <div class="form-group">
                        <label for="localidade_nome">Localidade:</label>
                        <select id="localidade_nome" name="localidade_nome" class="select2-single" required>
                            <option value="">Selecione ou digite uma localidade</option>
                            </select>
                    </div>
                    <div class="form-group">
                        <label for="unidade_nome">Nome da Unidade:</label>
                        <input type="text" id="unidade_nome" name="unidade_nome" required>
                    </div>
                    <div class="form-group">
                        <label for="data">Data:</label>
                        <input type="date" id="data" name="data" required>
                    </div>
                    <div class="form-group">
                        <label for="responsavel">Responsável:</label>
                        <input type="text" id="responsavel" name="responsavel" required>
                    </div>
                    <div class="form-group">
                        <label for="tipo_piso">Tipo de Piso:</label>
                        <select id="tipo_piso" name="tipo_piso" required>
                            {% for piso in tipos_piso %}
                                <option value="{{ piso }}">{{ piso }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <h3>Medidas de Áreas Fixas:</h3>
                    <div class="inline-fields">
                        <div>
                            <label for="area_interna_comprimento">Área Interna (C):</label>
                            <input type="text" id="area_interna_comprimento" name="area_interna_comprimento" placeholder="Comprimento (m)">
                        </div>
                        <div>
                            <label for="area_interna_largura">Área Interna (L):</label>
                            <input type="text" id="area_interna_largura" name="area_interna_largura" placeholder="Largura (m)">
                        </div>
                    </div>
                    <div class="inline-fields">
                        <div>
                            <label for="area_externa_comprimento">Área Externa (C):</label>
                            <input type="text" id="area_externa_comprimento" name="area_externa_comprimento" placeholder="Comprimento (m)">
                        </div>
                        <div>
                            <label for="area_externa_largura">Área Externa (L):</label>
                            <input type="text" id="area_externa_largura" name="area_externa_largura" placeholder="Largura (m)">
                        </div>
                    </div>
                    <div class="inline-fields">
                        <div>
                            <label for="vestiario_comprimento">Vestiário (C):</label>
                            <input type="text" id="vestiario_comprimento" name="vestiario_comprimento" placeholder="Comprimento (m)">
                        </div>
                        <div>
                            <label for="vestiario_largura">Vestiário (L):</label>
                            <input type="text" id="vestiario_largura" name="vestiario_largura" placeholder="Largura (m)">
                        </div>
                    </div>
                    
                    <h3>Medidas de Vidros:</h3>
                    <div class="form-group">
                        <label>A unidade possui vidros?</label>
                        <input type="radio" id="vidros_sim" name="tem_vidros" value="sim"> <label for="vidros_sim" class="radio-label">Sim</label>
                        <input type="radio" id="vidros_nao" name="tem_vidros" value="nao" checked> <label for="vidros_nao" class="radio-label">Não</label>
                    </div>
                    <div id="vidros_campos" style="display: none;">
                        <div class="form-group">
                            <label for="vidros_tipo">Tipo de Vidro:</label>
                            <input type="text" id="vidros_tipo" name="vidros_tipo">
                        </div>
                        <div class="form-group">
                            <label for="vidros_quantidade">Quantidade de Vidros:</label>
                            <input type="number" id="vidros_quantidade" name="vidros_quantidade" min="0">
                        </div>
                        <div class="form-group">
                            <label for="vidros_observacao">Observação sobre Vidros:</label>
                            <textarea id="vidros_observacao" name="vidros_observacao"></textarea>
                        </div>
                    </div>

                    <h3>Medidas Dinâmicas (Adicionar Linha):</h3>
                    <div class="medidas-dinamicas">
                        <div class="inline-fields">
                            <div>
                                <label for="medida_tipo">Tipo de Medida:</label>
                                <select id="medida_tipo" name="medida_tipo">
                                    {% for tipo in tipos_medida %}
                                        <option value="{{ tipo }}">{{ tipo }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label for="medida_comprimento">Comprimento (m):</label>
                                <input type="text" id="medida_comprimento" name="medida_comprimento" placeholder="Comprimento">
                            </div>
                            <div>
                                <label for="medida_largura">Largura (m):</label>
                                <input type="text" id="medida_largura" name="medida_largura" placeholder="Largura">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="button" id="adicionarMedidaBtn" class="btn btn-secondary">Adicionar Medida</button>
                            <button type="button" id="removerMedidaBtn" class="btn btn-warning">Remover Medida</button>
                            <button type="button" id="repetirMedidaBtn" class="btn btn-info">Repetir Medida</button>
                        </div>
                        <h4>Medidas Adicionadas:</h4>
                        <ul id="medidasList" class="medidas-list">
                            </ul>
                        <input type="hidden" id="medidas_dinamicas_json" name="medidas_dinamicas_json">
                    </div>

                    <div class="form-group">
                        <label for="tipo_parede">Tipo de Parede:</label>
                        <select id="tipo_parede" name="tipo_parede" required>
                            {% for parede in tipos_parede %}
                                <option value="{{ parede }}">{{ parede }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="observacoes_gerais">Observações Gerais:</label>
                        <textarea id="observacoes_gerais" name="observacoes_gerais" rows="4"></textarea>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Salvar Unidade</button>
                        <button type="button" id="novaUnidadeBtn" class="btn btn-secondary">Limpar Formulário</button>
                    </div>
                </form>
            </section>

            <section class="section-right">
                <h2>Localidades Cadastradas</h2>
                {% if localidades %}
                    <ul class="localidade-list">
                        {% for localidade in localidades %}
                            <li>
                                <a href="{{ url_for('ver_localidade', nome_localidade=localidade) }}">{{ localidade }}</a>
                                <a href="{{ url_for('download_excel', nome_localidade=localidade) }}" class="btn btn-success btn-small">Download Excel</a>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>Nenhuma localidade cadastrada ainda. Adicione uma nova!</p>
                {% endif %}
            </section>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        // Funções para Select2 e lógica de formulário
        $(document).ready(function() {
            // Inicializar Select2 para seleção de localidades
            $('.select2-single').select2({
                placeholder: "Selecione ou digite uma localidade",
                allowClear: true,
                tags: true, // Permite digitar novas tags (localidades)
                data: {{ localidades_json | safe }} // Carrega as localidades existentes
            });

            // Setar a data atual no campo de data
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Mês é 0-indexado
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('data').value = `${yyyy}-${mm}-${dd}`;

            // Lógica para mostrar/esconder campos de vidros
            const vidrosSim = document.getElementById('vidros_sim');
            const vidrosNao = document.getElementById('vidros_nao');
            const vidrosCampos = document.getElementById('vidros_campos');

            function toggleVidrosCampos() {
                if (vidrosSim.checked) {
                    vidrosCampos.style.display = 'block';
                } else {
                    vidrosCampos.style.display = 'none';
                }
            }
            vidrosSim.addEventListener('change', toggleVidrosCampos);
            vidrosNao.addEventListener('change', toggleVidrosCampos);
            toggleVidrosCampos(); // Chama ao carregar a página para definir o estado inicial

            // Lógica para medidas dinâmicas
            let medidasData = []; // Array para armazenar as medidas [tipo, comprimento, largura, area]
            const medidasList = document.getElementById('medidasList');
            const medidasJsonInput = document.getElementById('medidas_dinamicas_json');

            function updateMeasuresListAndHiddenFields() {
                medidasList.innerHTML = '';
                medidasData.forEach((medida, index) => {
                    const li = document.createElement('li');
                    li.setAttribute('data-index', index); // Adiciona um índice para fácil remoção
                    li.innerHTML = `
                        <span>${medida[0]}: ${medida[1]}m x ${medida[2]}m = ${medida[3].toFixed(2)} m²</span>
                        <button type="button" class="remove-medida-btn" data-index="${index}">X</button>
                    `;
                    medidasList.appendChild(li);
                });
                medidasJsonInput.value = JSON.stringify(medidasData);
            }

            // Adicionar Medida
            document.getElementById('adicionarMedidaBtn').addEventListener('click', () => {
                const tipo = document.getElementById('medida_tipo').value;
                let comprimento = document.getElementById('medida_comprimento').value.replace(',', '.');
                let largura = document.getElementById('medida_largura').value.replace(',', '.');

                // Validar e converter para float
                comprimento = parseFloat(comprimento);
                largura = parseFloat(largura);

                if (!tipo || isNaN(comprimento) || isNaN(largura) || comprimento <= 0 || largura <= 0) {
                    alert('Por favor, preencha o tipo, comprimento e largura válidos para a medida.');
                    return;
                }

                const area = comprimento * largura;
                medidasData.push([tipo, comprimento, largura, area]);
                updateMeasuresListAndHiddenFields();

                // Limpa os campos após adicionar
                document.getElementById('medida_tipo').value = 'Vidro'; // Volta ao padrão
                document.getElementById('medida_comprimento').value = '';
                document.getElementById('medida_largura').value = '';
            });

            // Remover Medida (com delegação de evento)
            medidasList.addEventListener('click', (event) => {
                if (event.target.classList.contains('remove-medida-btn')) {
                    const indexToRemove = parseInt(event.target.dataset.index);
                    medidasData.splice(indexToRemove, 1);
                    updateMeasuresListAndHiddenFields();
                }
            });

            // Repetir Medida
            document.getElementById('repetirMedidaBtn').addEventListener('click', () => {
                const selectedLi = medidasList.querySelector('li.selected');
                if (selectedLi) {
                    const indexToRepeat = parseInt(selectedLi.dataset.index);
                    const medidaParaRepetir = medidasData[indexToRepeat];
                    
                    const count = prompt("Quantas vezes deseja repetir esta medida?");
                    if (count !== null && !isNaN(parseInt(count)) && parseInt(count) > 0) {
                        for (let i = 0; i < parseInt(count); i++) {
                            medidasData.push([...medidaParaRepetir]); // Adiciona uma cópia
                        }
                        updateMeasuresListAndHiddenFields();
                    } else if (count !== null) {
                        alert("Por favor, digite um número inteiro positivo.");
                    }
                } else {
                    alert("Selecione uma medida para repetir.");
                }
            });

            // Funcionalidade de seleção de itens na lista de medidas
            medidasList.addEventListener('click', (event) => {
                // Remove a classe 'selected' de todos os itens
                medidasList.querySelectorAll('li').forEach(li => li.classList.remove('selected'));
                // Adiciona a classe 'selected' ao item clicado, se for um LI
                if (event.target.tagName === 'LI') {
                    event.target.classList.add('selected');
                } else if (event.target.closest('li')) { // Se clicou em um span ou botão dentro do LI
                    event.target.closest('li').classList.add('selected');
                }
            });

            // Botão "Limpar Formulário"
            document.getElementById('novaUnidadeBtn').addEventListener('click', () => {
                document.getElementById('cadastroForm').reset();
                document.getElementById('data').value = `${yyyy}-${mm}-${dd}`;
                document.getElementById('vidros_nao').checked = true;
                toggleVidrosCampos(); // Esconde os campos de vidro se "Não" estiver selecionado
                medidasData = []; // Limpa as medidas dinâmicas
                updateMeasuresListAndHiddenFields(); // Atualiza a lista visual e o campo oculto
                
                // Reset Select2 (se necessário, para voltar ao placeholder)
                $('.select2-single').val(null).trigger('change');
                
                document.getElementById('localidade_nome').focus(); // Coloca o foco no primeiro campo relevante
            });
        });
    </script>
</body>
</html>