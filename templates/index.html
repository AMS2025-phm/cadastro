<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Localidades e Unidades</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        /* Estilos adicionais para Select2 ou para o layout específico desta página */
        .select2-container--default .select2-selection--single {
            height: 40px;
            display: flex;
            align-items: center;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .select2-container--default .select2-selection--multiple { /* Estilo para select multiple */
            min-height: 40px;
            border-radius: 5px;
            border: 1px solid #ccc;
            padding: 5px;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 38px;
        }
        .select2-container .select2-selection--single .select2-selection__rendered {
            line-height: 38px;
        }
        .app-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px; /* Espaçamento entre as seções */
            margin-top: 30px;
        }
        .section-left, .section-right {
            flex: 1; /* Permite que as seções ocupem o espaço disponível */
            min-width: 300px; /* Largura mínima para evitar quebras estranhas */
        }
        .section-right {
            border-left: 1px solid #eee; /* Separador visual */
            padding-left: 30px;
        }
        @media (max-width: 768px) {
            .app-content {
                flex-direction: column;
            }
            .section-right {
                border-left: none;
                border-top: 1px solid #eee;
                padding-left: 0;
                padding-top: 30px;
            }
        }
        .medidas-dinamicas {
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            background-color: #fcfcfc;
            margin-top: 20px;
        }
        .medidas-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
            max-height: 200px; /* Altura máxima para rolagem */
            overflow-y: auto; /* Adiciona barra de rolagem se necessário */
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 5px;
        }
        .medidas-list li {
            background-color: #e9ecef;
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }
        .medidas-list li.selected {
            background-color: #cfe2ff; /* Cor de seleção */
            border-color: #0d6efd;
        }
        .medidas-list li button {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.1em;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .btn-group .btn {
            flex: 1;
        }
        .inline-fields {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 15px; /* Espaçamento entre grupos de campos */
        }
        .inline-fields > div {
            flex: 1;
        }
        .inline-fields label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .inline-fields input {
            width: calc(100% - 20px); /* Ajusta largura com padding */
        }
        .localidade-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f8f8;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px 15px;
            margin-bottom: 10px;
        }
        .localidade-list li a {
            text-decoration: none;
            color: #007bff;
            font-weight: bold;
        }
        .form-group small { /* Para dicas em campos multiple */
            display: block;
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 4px;
        }
        .radio-label-inline {
            font-weight: normal;
            margin-left: 5px;
            margin-right: 15px;
        }

    </style>
</head>
<body>
    <div class="container">
        <header class="app-header">
            <h1>Cadastro de Unidades e Medidas</h1>
            <nav>
                <a href="{{ url_for('index') }}" class="btn">Início</a>
                <a href="{{ url_for('nova_localidade') }}" class="btn">Nova Localidade</a>
                <a href="{{ url_for('logout') }}" class="btn btn-danger">Sair ({{ g.user.username }})</a>
            </nav>
        </header>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flashes">
                    {% for category, message in messages %}
                        <li class="{{ category }}">{{ message }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <div class="app-content">
            <section class="section-left">
                <h2>Dados da Unidade</h2>
                <form id="cadastroForm" action="{{ url_for('adicionar_unidade') }}" method="POST">
                    <div class="form-group">
                        <label for="localidade_nome">Localidade:</label>
                        <select id="localidade_nome" name="localidade_nome" class="select2-single" required>
                            <option value="">Selecione ou digite uma localidade</option>
                            </select>
                    </div>
                    <div class="form-group">
                        <label for="unidade_nome">Nome da Unidade:</label>
                        <input type="text" id="unidade_nome" name="unidade_nome" required>
                    </div>
                    <div class="form-group">
                        <label for="data">Data:</label>
                        <input type="date" id="data" name="data" required>
                    </div>
                    <div class="form-group">
                        <label for="responsavel">Responsável:</label>
                        <input type="text" id="responsavel" name="responsavel" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="tipo_piso">Tipo(s) de Piso:</label>
                        <select id="tipo_piso" name="tipo_piso" multiple required class="select2-multiple">
                            {% for piso in tipos_piso %}
                                <option value="{{ piso }}">{{ piso }}</option>
                            {% endfor %}
                        </select>
                        <small>Segure Ctrl (ou Cmd em Mac) para selecionar múltiplos.</small>
                    </div>

                    <div class="form-group">
                        <label>A unidade possui vidros?</label>
                        <input type="radio" id="vidros_sim" name="tem_vidros" value="sim"> <label for="vidros_sim" class="radio-label-inline">Sim</label>
                        <input type="radio" id="vidros_nao" name="tem_vidros" value="nao" checked> <label for="vidros_nao" class="radio-label-inline">Não</label>
                    </div>

                    <div id="vidros_campos_gerais" style="display: none;">
                        <div class="form-group">
                            <label for="vidros_tipo">Tipo de Vidro:</label>
                            <input type="text" id="vidros_tipo" name="vidros_tipo">
                        </div>
                        <div class="form-group">
                            <label for="vidros_quantidade">Quantidade de Vidros:</label>
                            <input type="number" id="vidros_quantidade" name="vidros_quantidade" min="0">
                        </div>
                        <div class="form-group">
                            <label for="vidros_observacao">Observação sobre Vidros:</label>
                            <textarea id="vidros_observacao" name="vidros_observacao"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>A unidade possui vidro alto?</label>
                            <input type="radio" id="vidro_alto_sim" name="possui_vidro_alto" value="sim"> <label for="vidro_alto_sim" class="radio-label-inline">Sim</label>
                            <input type="radio" id="vidro_alto_nao" name="possui_vidro_alto" value="nao" checked> <label for="vidro_alto_nao" class="radio-label-inline">Não</label>
                        </div>
                        <div id="vidro_alto_perigo_campo" style="display: none;">
                            <div class="form-group">
                                <label>O vidro alto representa perigo?</label>
                                <input type="radio" id="vidro_perigoso_sim" name="vidro_alto_perigoso" value="sim"> <label for="vidro_perigoso_sim" class="radio-label-inline">Sim</label>
                                <input type="radio" id="vidro_perigoso_nao" name="vidro_alto_perigoso" value="nao" checked> <label for="vidro_perigoso_nao" class="radio-label-inline">Não</label>
                            </div>
                        </div>
                    </div>

                    <h3>Medidas Dinâmicas (Adicionar Linha):</h3>
                    <div class="medidas-dinamicas">
                        <div class="inline-fields">
                            <div>
                                <label for="medida_tipo">Tipo de Medida:</label>
                                <select id="medida_tipo" name="medida_tipo">
                                    {% for tipo_m in tipos_medida %} <option value="{{ tipo_m }}">{{ tipo_m }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label for="medida_comprimento">Comprimento (m):</label>
                                <input type="text" id="medida_comprimento" name="medida_comprimento" placeholder="Comprimento">
                            </div>
                            <div>
                                <label for="medida_largura">Largura (m):</label>
                                <input type="text" id="medida_largura" name="medida_largura" placeholder="Largura">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="button" id="adicionarMedidaBtn" class="btn btn-secondary">Adicionar Medida</button>
                            <button type="button" id="removerMedidaBtn" class="btn btn-warning">Remover Selecionada</button>
                            <button type="button" id="repetirMedidaBtn" class="btn btn-info">Repetir Selecionada</button>
                        </div>
                        <h4>Medidas Adicionadas:</h4>
                        <ul id="medidasList" class="medidas-list"></ul>
                        <input type="hidden" id="medidas_dinamicas_json" name="medidas_dinamicas_json">
                    </div>

                    <div class="form-group">
                        <label for="tipo_parede">Tipo(s) de Parede:</label>
                        <select id="tipo_parede" name="tipo_parede" multiple required class="select2-multiple">
                            {% for parede in tipos_parede %}
                                <option value="{{ parede }}">{{ parede }}</option>
                            {% endfor %}
                        </select>
                        <small>Segure Ctrl (ou Cmd em Mac) para selecionar múltiplos.</small>
                    </div>

                    <div class="form-group">
                        <label for="observacoes_gerais">Observações Gerais:</label>
                        <textarea id="observacoes_gerais" name="observacoes_gerais" rows="4"></textarea>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Salvar Unidade</button>
                        <button type="button" id="novaUnidadeBtn" class="btn btn-secondary">Limpar Formulário</button>
                    </div>
                </form>
            </section>

            <section class="section-right">
                <h2>Localidades Cadastradas</h2>
                {% if localidades %}
                    <ul class="localidade-list">
                        {% for localidade in localidades %}
                            <li>
                                <a href="{{ url_for('ver_localidade', nome_localidade=localidade) }}">{{ localidade }}</a>
                                <a href="{{ url_for('download_excel', nome_localidade=localidade) }}" class="btn btn-success btn-small">Download Excel</a>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>Nenhuma localidade cadastrada ainda. Adicione uma nova!</p>
                {% endif %}
            </section>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            // Inicializar Select2 para seleção de localidades (single)
            $('#localidade_nome').select2({
                placeholder: "Selecione ou digite uma localidade",
                allowClear: true,
                tags: true, 
                data: {{ localidades_json | safe }}
            });

            // Inicializar Select2 para seleção múltipla de pisos e paredes
            $('#tipo_piso.select2-multiple, #tipo_parede.select2-multiple').select2({
                placeholder: "Selecione uma ou mais opções",
                allowClear: true,
                // tags: true // Descomente se quiser permitir adicionar novos tipos dinamicamente
            });


            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('data').value = `${yyyy}-${mm}-${dd}`;

            // Lógica para mostrar/esconder campos de vidros gerais
            const vidrosSim = document.getElementById('vidros_sim');
            const vidrosNao = document.getElementById('vidros_nao');
            const vidrosCamposGerais = document.getElementById('vidros_campos_gerais');
            // Lógica para vidro alto e perigo
            const vidroAltoSim = document.getElementById('vidro_alto_sim');
            const vidroAltoNao = document.getElementById('vidro_alto_nao');
            const vidroAltoPerigoCampo = document.getElementById('vidro_alto_perigo_campo');

            function toggleVidrosCamposGerais() {
                const display = vidrosSim.checked ? 'block' : 'none';
                vidrosCamposGerais.style.display = display;
                if (!vidrosSim.checked) { // Se não tem vidros, não tem vidro alto
                    vidroAltoNao.checked = true; 
                    toggleVidroAltoPerigoCampo(); // Esconde campo de perigo
                }
            }

            function toggleVidroAltoPerigoCampo() {
                if (vidrosSim.checked && vidroAltoSim.checked) {
                    vidroAltoPerigoCampo.style.display = 'block';
                } else {
                    vidroAltoPerigoCampo.style.display = 'none';
                    // Se "vidro alto" for "não", garantir que "perigoso" também seja "não" ou resetado
                    document.getElementById('vidro_perigoso_nao').checked = true;
                }
            }

            vidrosSim.addEventListener('change', toggleVidrosCamposGerais);
            vidrosNao.addEventListener('change', toggleVidrosCamposGerais);
            vidroAltoSim.addEventListener('change', toggleVidroAltoPerigoCampo);
            vidroAltoNao.addEventListener('change', toggleVidroAltoPerigoCampo);
            
            toggleVidrosCamposGerais(); // Estado inicial
            toggleVidroAltoPerigoCampo(); // Estado inicial


            let medidasData = [];
            const medidasList = document.getElementById('medidasList');
            const medidasJsonInput = document.getElementById('medidas_dinamicas_json');
            let selectedMedidaIndex = -1; // Para rastrear a medida selecionada

            function updateMeasuresListAndHiddenFields() {
                medidasList.innerHTML = '';
                medidasData.forEach((medida, index) => {
                    const li = document.createElement('li');
                    li.setAttribute('data-index', index);
                    li.innerHTML = `
                        <span>${medida[0]}: ${medida[1]}m x ${medida[2]}m = ${medida[3].toFixed(2)} m²</span>
                        <button type="button" class="remove-medida-item-btn" data-index="${index}">X</button> 
                    `; // Renomeado botão para evitar conflito
                    if (index === selectedMedidaIndex) {
                        li.classList.add('selected');
                    }
                    medidasList.appendChild(li);
                });
                medidasJsonInput.value = JSON.stringify(medidasData);
            }
            
            // Selecionar item na lista
             medidasList.addEventListener('click', (event) => {
                let targetLi = null;
                if (event.target.tagName === 'LI') {
                    targetLi = event.target;
                } else if (event.target.closest('li')) {
                    targetLi = event.target.closest('li');
                }

                if (targetLi) {
                    const index = parseInt(targetLi.dataset.index);
                    if (selectedMedidaIndex === index) { // Desselecionar se clicar no mesmo
                        selectedMedidaIndex = -1;
                        targetLi.classList.remove('selected');
                    } else {
                        medidasList.querySelectorAll('li').forEach(li => li.classList.remove('selected'));
                        targetLi.classList.add('selected');
                        selectedMedidaIndex = index;
                    }
                }
                // Remover item individualmente
                if (event.target.classList.contains('remove-medida-item-btn')) {
                    const indexToRemove = parseInt(event.target.dataset.index);
                    medidasData.splice(indexToRemove, 1);
                    if (selectedMedidaIndex === indexToRemove) selectedMedidaIndex = -1;
                    else if (selectedMedidaIndex > indexToRemove) selectedMedidaIndex--;
                    updateMeasuresListAndHiddenFields();
                }
            });


            document.getElementById('adicionarMedidaBtn').addEventListener('click', () => {
                const tipo = document.getElementById('medida_tipo').value; // Ponto 4: Mantém o tipo selecionado
                let comprimento = document.getElementById('medida_comprimento').value.replace(',', '.');
                let largura = document.getElementById('medida_largura').value.replace(',', '.');

                comprimento = parseFloat(comprimento);
                largura = parseFloat(largura);

                if (!tipo || isNaN(comprimento) || isNaN(largura) || comprimento <= 0 || largura <= 0) {
                    alert('Por favor, preencha o tipo, comprimento e largura válidos para a medida.');
                    return;
                }

                const area = comprimento * largura;
                medidasData.push([tipo, comprimento, largura, area]);
                updateMeasuresListAndHiddenFields();
                
                // Ponto 4: Não reseta o tipo, apenas comprimento e largura
                document.getElementById('medida_comprimento').value = '';
                document.getElementById('medida_largura').value = '';
                document.getElementById('medida_comprimento').focus(); // Foco no comprimento para próxima entrada
            });

            document.getElementById('removerMedidaBtn').addEventListener('click', () => {
                if (selectedMedidaIndex !== -1) {
                    medidasData.splice(selectedMedidaIndex, 1);
                    selectedMedidaIndex = -1; // Resetar seleção
                    updateMeasuresListAndHiddenFields();
                } else {
                    alert("Selecione uma medida para remover.");
                }
            });
            
            document.getElementById('repetirMedidaBtn').addEventListener('click', () => {
                if (selectedMedidaIndex !== -1) {
                    const medidaParaRepetir = medidasData[selectedMedidaIndex];
                    const count = prompt("Quantas vezes deseja repetir esta medida?");
                    if (count !== null && !isNaN(parseInt(count)) && parseInt(count) > 0) {
                        for (let i = 0; i < parseInt(count); i++) {
                            medidasData.push([...medidaParaRepetir]);
                        }
                        updateMeasuresListAndHiddenFields();
                    } else if (count !== null) {
                        alert("Por favor, digite um número inteiro positivo.");
                    }
                } else {
                    alert("Selecione uma medida para repetir.");
                }
            });


            document.getElementById('novaUnidadeBtn').addEventListener('click', () => {
                document.getElementById('cadastroForm').reset();
                document.getElementById('data').value = `${yyyy}-${mm}-${dd}`;
                
                // Reset Select2 para single (localidade)
                $('#localidade_nome').val(null).trigger('change');
                // Reset Select2 para multiple (piso e parede)
                $('#tipo_piso.select2-multiple').val(null).trigger('change');
                $('#tipo_parede.select2-multiple').val(null).trigger('change');

                // Reset campos de vidro
                document.getElementById('vidros_nao').checked = true;
                toggleVidrosCamposGerais(); // Esconde os campos de vidro se "Não" estiver selecionado
                document.getElementById('vidro_alto_nao').checked = true; // Reset vidro alto
                toggleVidroAltoPerigoCampo(); // Esconde perigo

                medidasData = []; 
                selectedMedidaIndex = -1;
                updateMeasuresListAndHiddenFields(); 
                
                document.getElementById('localidade_nome').focus(); 
            });
        });
    </script>
</body>
</html>